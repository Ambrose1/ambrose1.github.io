<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>dispatch_source_xx 方法学习 - Ambrose&#x27;s Blog</title><meta name="description" content="dispatch_source_set_event_handler dispatch_source_set_event_handler 是 Grand Central Dispatch (GCD) 框架中的一个函数，用于为 dispatch source 设置一个事件处理器。当特定的事件发生时，这个事件处理器会被调用。Dispatch source&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="stylesheet" href="https://ambrose1.github.io/media/plugins/syntaxHighlighter/prism-black.css"><meta name="theme-color" content="#17181E" media="(prefers-color-scheme: dark)"><meta name="theme-color" content="#D73A42" media="(prefers-color-scheme: light)"><meta name="msapplication-navbutton-color" content="#D73A42"><meta name="apple-mobile-web-app-status-bar-style" content="#D73A42"><link rel="canonical" href="https://ambrose1.github.io/dispatch_source_xx-fang-fa-xue-xi.html"><link rel="alternate" type="application/atom+xml" href="https://ambrose1.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://ambrose1.github.io/feed.json"><meta property="og:title" content="dispatch_source_xx 方法学习"><meta property="og:image" content="https://ambrose1.github.io/media/website/20150708214812.jpg"><meta property="og:site_name" content="Ambrose's Blog"><meta property="og:description" content="dispatch_source_set_event_handler dispatch_source_set_event_handler 是 Grand Central Dispatch (GCD) 框架中的一个函数，用于为 dispatch source 设置一个事件处理器。当特定的事件发生时，这个事件处理器会被调用。Dispatch source&hellip;"><meta property="og:url" content="https://ambrose1.github.io/dispatch_source_xx-fang-fa-xue-xi.html"><meta property="og:type" content="article"><link rel="preload" href="https://ambrose1.github.io/assets/dynamic/fonts/publicsans/publicsans.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://ambrose1.github.io/assets/css/style.css?v=df6e0dd7b95ea201317f082730fc6b90"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://ambrose1.github.io/dispatch_source_xx-fang-fa-xue-xi.html"},"headline":"dispatch_source_xx 方法学习","datePublished":"2024-08-13T14:17","dateModified":"2024-08-13T14:25","image":{"@type":"ImageObject","url":"https://ambrose1.github.io/media/website/20150708214812.jpg","height":false,"width":false},"description":"dispatch_source_set_event_handler dispatch_source_set_event_handler 是 Grand Central Dispatch (GCD) 框架中的一个函数，用于为 dispatch source 设置一个事件处理器。当特定的事件发生时，这个事件处理器会被调用。Dispatch source&hellip;","author":{"@type":"Person","name":"Ambrose duan","url":"https://ambrose1.github.io/authors/ambrose-duan/"},"publisher":{"@type":"Organization","name":"Ambrose duan","logo":{"@type":"ImageObject","url":"https://ambrose1.github.io/media/website/20150708214812.jpg","height":false,"width":false}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body><div class="content"><div class="left-bar"><div class="left-bar__inner"><header class="header"><a class="logo" href="https://ambrose1.github.io/"><img src="https://ambrose1.github.io/media/website/20150708214812.jpg" alt="Ambrose&#x27;s Blog" width="" height=""> </a><a class="logo logo--atbottom" href="./"><img src="https://ambrose1.github.io/media/website/20150708214812.jpg" alt="Ambrose&#x27;s Blog" width="" height=""></a></header></div></div><main class="main"><article class="post"><div class="main__inner"><div class="post__meta"><div class="post__author"><div><a href="https://ambrose1.github.io/authors/ambrose-duan/" class="post__author__name">Ambrose duan</a></div></div><div class="post__date"><time datetime="2024-08-13T14:17">8月 13, 2024</time></div></div><header class="post__header"><h1 class="post__title">dispatch_source_xx 方法学习</h1></header><div class="post__entry"><h1 id="dispatch_source_set_event_handler">dispatch_source_set_event_handler</h1><p><code>dispatch_source_set_event_handler</code> 是 Grand Central Dispatch (GCD) 框架中的一个函数，用于为 dispatch source 设置一个事件处理器。当特定的事件发生时，这个事件处理器会被调用。Dispatch source 是 GCD 中用于抽象化不同的系统事件的一个对象，它可以是基于各种不同事件的，比如文件描述符的读取或写入、Unix信号、定时器、文件系统事件等。</p><p>以下是 <code>dispatch_source_set_event_handler</code> 函数的一些关键点：</p><h3 id="函数原型">函数原型</h3><pre><code class="language-c">void dispatch_source_set_event_handler(dispatch_source_t source,
                                        dispatch_queue_t queue,
                                        dispatch_block_t handler);
</code></pre><h3 id="参数说明">参数说明</h3><ul><li><code>source</code>: 要设置事件处理器的 dispatch source 对象。</li><li><code>queue</code>: 指定在哪个 dispatch queue 上执行事件处理器。如果传入 <code>NULL</code>，将使用 source 创建时指定的队列。</li><li><code>handler</code>: 当 dispatch source 触发事件时调用的 block。这个 block 需要符合 <code>dispatch_block_t</code> 类型，没有参数并返回 <code>void</code>。</li></ul><h3 id="使用场景">使用场景</h3><ul><li><strong>文件 I/O</strong>: 当需要从文件描述符中读取数据或向其写入数据时，可以设置一个事件处理器来处理这些 I/O 操作。</li><li><strong>用户交互</strong>: 在用户与应用程序交互时，如按钮点击或手势识别，可以设置事件处理器以响应这些交互事件。</li><li><strong>定时任务</strong>: 除了使用 <code>dispatch_source_set_timer</code> 设置定时器，还可以设置一个事件处理器来处理每次定时器触发时的逻辑。</li><li><strong>系统事件</strong>: 对于一些系统级的事件，如电源变化、网络状态变化等，也可以设置事件处理器来响应这些事件。</li></ul><h3 id="示例代码">示例代码</h3><pre><code class="language-c">dispatch_source_t source = dispatch_source_create(DISPATCH_SOURCE_TYPE_READ, fd, 0, queue);
dispatch_source_set_event_handler(source, ^{
    // 处理事件，例如读取数据
    size_t length = 1024;
    char buffer[length];
    ssize_t bytesRead = read(fd, &amp;buffer, length);
    if (bytesRead &gt; 0) {
        // 处理读取到的数据
    }
});
dispatch_source_set_cancel_handler(source, ^{
    close(fd); // 清理资源
});
</code></pre><p>在上面的示例代码中，我们创建了一个基于文件描述符读取的 dispatch source，并设置了一个事件处理器 block 来处理读取到的数据。同时，我们也设置了一个取消处理器，当 source 被取消时，执行清理操作（如关闭文件描述符）。</p><p><code>dispatch_source_set_event_handler</code> 提供了高度的灵活性和强大的功能，允许开发者在现代多核系统上有效地处理各种事件。</p><h1 id="hailuoai">hailuoai:</h1><p><code>dispatch_source_set_event_handler</code> 是一个函数，用于设置一个 <code>dispatch_source_t</code> 类型的事件源的事件处理函数。这个函数允许你定义当事件源触发事件时应该执行的操作。事件源可以是计时器、信号、描述符、进程或线程等。</p><h3 id="函数原型-1">函数原型</h3><pre><code class="language-c">void dispatch_source_set_event_handler(dispatch_source_t source, void (^handler)(void));
</code></pre><h3 id="参数说明-1">参数说明</h3><ul><li><code>source</code>: 这是一个 <code>dispatch_source_t</code> 类型的事件源，它代表了你想要监听的事件源。</li><li><code>handler</code>: 这是一个块（block），当事件源触发事件时，这个块将被调用执行。块中可以包含你希望在事件发生时执行的代码。</li></ul><h3 id="使用场景-1">使用场景</h3><p><code>dispatch_source_set_event_handler</code> 常用于以下场景：</p><ul><li><strong>计时器事件</strong>：当使用 <code>dispatch_source_create</code> 创建一个计时器事件源时，你可以使用 <code>dispatch_source_set_event_handler</code> 来设置一个块，该块将在计时器触发时执行。</li><li><strong>信号事件</strong>：当创建一个信号事件源时，你可以设置一个块来响应特定的信号。</li><li><strong>描述符事件</strong>：当创建一个描述符事件源时，你可以设置一个块来响应文件描述符的读写事件。</li><li><strong>进程和线程事件</strong>：当创建一个进程或线程事件源时，你可以设置一个块来响应进程或线程的结束。</li></ul><h3 id="能力说明">能力说明</h3><ul><li><strong>异步执行</strong>：事件处理函数在事件源触发时异步执行，这允许你的应用程序继续执行其他任务，而不会被阻塞。</li><li><strong>线程安全</strong>：事件处理函数在合适的线程上执行，通常是创建事件源时指定的队列上。</li><li><strong>可配置性</strong>：你可以通过 <code>dispatch_source_set_timer</code>、<code>dispatch_source_set_cancel_handler</code> 等函数来配置事件源的其他行为。</li></ul><h3 id="示例代码-1">示例代码</h3><pre><code class="language-c">dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);

// 设置计时器触发的时间间隔
uint64_t start = dispatch_time(DISPATCH_TIME_NOW, 2 * NSEC_PER_SEC);
uint64_t interval = 1 * NSEC_PER_SEC;
dispatch_source_set_timer(timer, start, interval, 0);

// 设置事件处理函数
dispatch_source_set_event_handler(timer, ^{
    NSLog(@&quot;Timer fired!&quot;);
});

// 启动计时器
dispatch_resume(timer);
</code></pre><p>在这个示例中，我们创建了一个计时器事件源，它每秒触发一次，并在控制台打印一条消息。</p><p>使用 <code>dispatch_source_set_event_handler</code> 可以让你的应用程序响应各种事件源的事件，从而实现复杂的异步逻辑。</p><h1 id="dispatch_source_set_timer">dispatch_source_set_timer</h1><p>这段代码是苹果系统编程中使用 Grand Central Dispatch (GCD) 框架的一部分，具体是关于 <code>dispatch_source_set_timer</code> 函数的文档注释。</p><p>以下是对这个函数及其参数的简要解释：</p><h3 id="函数名称">函数名称</h3><ul><li><code>dispatch_source_set_timer</code></li></ul><h3 id="函数功能">函数功能</h3><ul><li>设置定时器源的开始时间、间隔和延迟（leeway）值。</li></ul><h3 id="讨论">讨论</h3><ul><li>函数返回后，之前定时器值累积的任何待处理源数据将被清除。</li><li>下一次定时器触发将在 <code>start</code> 时间发生，之后每隔 <code>interval</code> 纳秒触发，直到定时器源被取消。</li><li>系统可能会延迟定时器的触发以提高电源效率和系统性能。允许的最大延迟可以通过 <code>leeway</code> 参数配置，最小延迟由系统控制。</li><li>对于在 <code>start</code> 时间的初始定时器触发，允许的最大延迟设置为 <code>leeway</code> 纳秒。</li><li>对于在 <code>start</code> + N * <code>interval</code> 的后续定时器触发，最大延迟是 <code>leeway</code> 和 <code>interval</code>/2 的最小值。</li><li>如果定时器源是使用 <code>DISPATCH_TIMER_STRICT</code> 掩码创建的，系统将尽最大努力严格观察提供的 <code>leeway</code> 值，即使它小于当前的最小延迟限制。即使指定了此标志，也应预期会有最小的延迟。</li><li><code>start</code> 参数还决定了用于定时器的时钟：如果 <code>start</code> 是 <code>DISPATCH_TIME_NOW</code> 或使用 <code>dispatch_time(3)</code> 创建的，则定时器基于系统启动时间（在苹果平台上通过 <code>mach_absolute_time()</code> 获取）。如果 <code>start</code> 是使用 <code>dispatch_walltime(3)</code> 创建的，则定时器基于 <code>gettimeofday(3)</code>。</li><li>如果定时器源已经被取消，则调用此函数没有效果。</li></ul><h3 id="参数">参数</h3><ul><li><code>start</code>: 定时器的开始时间。有关更多信息，请参阅 <code>dispatch_time()</code> 和 <code>dispatch_walltime()</code>。</li><li><code>interval</code>: 定时器的纳秒间隔。对于一次性定时器，使用 <code>DISPATCH_TIME_FOREVER</code>。</li><li><code>leeway</code>: 定时器的纳秒延迟。</li></ul><h3 id="可用性">可用性</h3><ul><li>此函数在 macOS 10.6 和 iOS 4.0 及以上版本中可用。</li></ul><h3 id="其他属性">其他属性</h3><ul><li><code>DISPATCH_EXPORT</code>: 表示该函数是库的导出符号。</li><li><code>DISPATCH_NONNULL_ALL</code>: 表示函数的所有参数都不应为 NULL。</li><li><code>DISPATCH_NOTHROW</code>: 表示该函数不会抛出异常。</li><li><code>DISPATCH_REFINED_FOR_SWIFT</code>: 表示该函数经过优化，可以在 Swift 中使用。</li></ul><p>这个函数是 GCD 框架中用于定时任务调度的重要工具，允许开发者在应用程序中实现精确的定时触发逻辑。</p></div><footer class="post__footer"><div class="post__last-updated">This article was updated on <time datetime="2024-08-13T14:25">8月 13, 2024</time></div><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fambrose1.github.io%2Fdispatch_source_xx-fang-fa-xue-xi.html" class="js-share facebook tltp tltp--top" aria-label="Facebook" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://ambrose1.github.io/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fambrose1.github.io%2Fdispatch_source_xx-fang-fa-xue-xi.html&amp;via=Ambrose's%20Blog&amp;text=dispatch_source_xx%20%E6%96%B9%E6%B3%95%E5%AD%A6%E4%B9%A0" class="js-share twitter tltp tltp--top" aria-label="Twitter" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://ambrose1.github.io/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fambrose1.github.io%2Fdispatch_source_xx-fang-fa-xue-xi.html&amp;media=undefined&amp;description=dispatch_source_xx%20%E6%96%B9%E6%B3%95%E5%AD%A6%E4%B9%A0" class="js-share pinterest tltp tltp--top" aria-label="Pinterest" rel="nofollow noopener noreferrer"><svg><use xlink:href="https://ambrose1.github.io/assets/svg/svg-map.svg#pinterest"/></svg> <span>Pinterest</span></a></div></footer></div></article></main><div class="right-bar"><div class="right-bar__inner"><div class="sidebar"><section class="box featured"><h3 class="box__title">Featured Posts</h3><ul class="featured__container"><li class="featured__item"><div><a href="https://ambrose1.github.io/mei-ri-xin-xi-chai.html" class="featured__title">每日信息差</a></div></li><li class="featured__item"><div><a href="https://ambrose1.github.io/ruby-kai-fa-gui-fan.html" class="featured__title">Ruby 开发规范</a></div></li></ul></section><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><div><a href="https://ambrose1.github.io/authors/ambrose-duan/" class="authors__title">Ambrose duan</a> <span class="authors__meta">Post: 10</span></div></li></ul></section><section class="box tags"><h3 class="box__title">Recommended Topics</h3><ul class="tags__list"><li class="tags__item"><a href="https://ambrose1.github.io/tags/ios/" class="btn btn--gray">iOS <sup>(2)</sup></a></li><li class="tags__item"><a href="https://ambrose1.github.io/tags/ruby/" class="btn btn--gray">Ruby <sup>(1)</sup></a></li></ul></section><section class="box newsletter"><h3 class="box__title">Subscribe to Mono</h3><p class="newsletter__desc">Sign up to receive email updates and to hear what's going on with us!</p><form>...</form></section><div class="box copyright">Powered by Publii - Open-Source CMS for Static Websites</div></div></div></div></div><script defer="defer" src="https://ambrose1.github.io/assets/js/scripts.min.js?v=12d8fcd46db8fdc7af6797ec26849875"></script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script defer="defer" src="https://ambrose1.github.io/media/plugins/syntaxHighlighter/prism.js"></script></body></html>